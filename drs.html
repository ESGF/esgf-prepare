

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Manage local data through the DRS &mdash; esgprep 2.7.4 documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="esgprep 2.7.4 documentation" href="index.html"/>
        <link rel="next" title="Check CV against configuration INI files" href="check-vocab.html"/>
        <link rel="prev" title="Fetch ESGF configuration INI files" href="fetch-ini.html"/> 

  
  <script src="static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="index.html" class="icon icon-home"> esgprep
          

          
          </a>

          
            
            
              <div class="version">
                2.7
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Generic usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="fetch-ini.html">Fetch ESGF configuration INI files</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Manage local data through the DRS</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#list-the-datasets-related-to-the-incoming-files">List the datasets related to the incoming files</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-a-facet-value">Set a facet value</a></li>
<li class="toctree-l2"><a class="reference internal" href="#enforce-a-facet-mapping">Enforce a facet mapping</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-up-the-version-upgrade">Set up the version upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualize-the-excepted-drs-tree">Visualize the excepted DRS tree</a></li>
<li class="toctree-l2"><a class="reference internal" href="#set-up-a-root-directory">Set up a root directory</a></li>
<li class="toctree-l2"><a class="reference internal" href="#list-unix-command-to-apply">List Unix command to apply</a></li>
<li class="toctree-l2"><a class="reference internal" href="#change-the-migration-mode">Change the migration mode</a></li>
<li class="toctree-l2"><a class="reference internal" href="#run-the-drs-upgrade">Run the DRS upgrade</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disable-checkum-comparison">Disable checkum comparison</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="check-vocab.html">Check CV against configuration INI files</a></li>
<li class="toctree-l1"><a class="reference internal" href="mapfiles.html">Generation mapfiles for ESGF publication</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">Frequently asked questions</a></li>
<li class="toctree-l1"><a class="reference internal" href="credits.html">Credits</a></li>
<li class="toctree-l1"><a class="reference internal" href="log.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="autodoc.html">Code documentation</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="index.html">esgprep</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="index.html">Docs</a> &raquo;</li>
      
    <li>Manage local data through the DRS</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="sources/drs.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="manage-local-data-through-the-drs">
<span id="drs"></span><h1>Manage local data through the DRS<a class="headerlink" href="#manage-local-data-through-the-drs" title="Permalink to this headline">¶</a></h1>
<p>The Data Reference Syntax (DRS) defines the way your data must be organised on your filesystem. This allows a proper
publication on the ESGF node. <code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> is designed to help ESGF data node managers to prepare incoming data for
publication, placing files in the DRS directory structure, and to manage multiple versions of publication-level datasets
in a way that minimises disk usage.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Only CMORized netCDF files are supported as incoming files.</p>
</div>
<p>Several <code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> actions are available to manage your local archive:</p>
<blockquote>
<div><ul class="simple">
<li><code class="docutils literal"><span class="pre">list</span></code> lists publication-level datasets,</li>
<li><code class="docutils literal"><span class="pre">tree</span></code> displays the final DRS tree,</li>
<li><code class="docutils literal"><span class="pre">todo</span></code> shows file operations pending for the next version,</li>
<li><code class="docutils literal"><span class="pre">upgrade</span></code> makes the changes to upgrade datasets to the next version.</li>
</ul>
</div></blockquote>
<p><code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> deduces the excepted DRS by scanning the incoming files and checking the facets against the
corresponding <code class="docutils literal"><span class="pre">esg.&lt;project&gt;.ini</span></code> file. The DRS facets values are deduced from:</p>
<blockquote>
<div><ol class="arabic simple">
<li>The command-line using <code class="docutils literal"><span class="pre">--set</span> <span class="pre">facet=value</span></code>. This flag can be used several times to set several facets values.</li>
<li>The filename pattern using the <code class="docutils literal"><span class="pre">filename_format</span></code> from the <code class="docutils literal"><span class="pre">esg.&lt;project&gt;.ini</span></code>.</li>
<li>The NetCDF global attributes by picking the attribute with the nearest name of the facet key.</li>
</ol>
</div></blockquote>
<div class="section" id="list-the-datasets-related-to-the-incoming-files">
<h2>List the datasets related to the incoming files<a class="headerlink" href="#list-the-datasets-related-to-the-incoming-files" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt>The resulting table lists each dataset with:</dt>
<dd><ul class="first last simple">
<li>the latest known version on the filesystem (i.e., the root directory),</li>
<li>the upgraded version to apply,</li>
<li>the number of related incoming files,</li>
<li>the total size of the upgraded dataset (i.e., the sum of all incoming files related to this upgrade).</li>
</ul>
</dd>
</dl>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/
</pre></div>
</div>
</div>
<div class="section" id="set-a-facet-value">
<h2>Set a facet value<a class="headerlink" href="#set-a-facet-value" title="Permalink to this headline">¶</a></h2>
<p>In some cases, a DRS facet value cannont by properly deduces from the above sources. To solve this issue, a facet value
can be set for the whole scan. By duplicating the flag several facet value can be enforced. If the same facet key is
used, only the last value will be considered.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/ --set-value <span class="nv">FACET_KEY</span><span class="o">=</span>VALUE
$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/ --set-value <span class="nv">FACET_KEY1</span><span class="o">=</span>VALUE1 --set-value <span class="nv">FACET_KEY2</span><span class="o">=</span>VALUE2
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For instance, the <code class="docutils literal"><span class="pre">product</span></code> facet in CMIP5 project is not part of the filename and is often set to
<code class="docutils literal"><span class="pre">output</span></code> in CMIP5 NetCDF global attributes however it should be <code class="docutils literal"><span class="pre">output1</span></code> or <code class="docutils literal"><span class="pre">output2</span></code>. Consequently, you can
use <code class="docutils literal"><span class="pre">--set-value</span> <span class="pre">product=output1</span></code> or <code class="docutils literal"><span class="pre">--set-value</span> <span class="pre">product=output2</span></code> depending on the dataset.</p>
</div>
</div>
<div class="section" id="enforce-a-facet-mapping">
<h2>Enforce a facet mapping<a class="headerlink" href="#enforce-a-facet-mapping" title="Permalink to this headline">¶</a></h2>
<p>Based on the same schema of the <code class="docutils literal"><span class="pre">--set-value</span></code> argument, the mappging between a (list of) facet key and a (list of)
particular NetCDF attribute can be enforced for the whole scan.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/ --set-key <span class="nv">FACET_KEY</span><span class="o">=</span>ATTRIBUTE
$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/ --set-key <span class="nv">FACET_KEY1</span><span class="o">=</span>ATTRIBUTE1 --set-value <span class="nv">FACET_KEY2</span><span class="o">=</span>ATTRIBUTE2
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For instance, the <code class="docutils literal"><span class="pre">institute</span></code> facet in CORDEX project is not part of the filename and corresponds to the
<code class="docutils literal"><span class="pre">institute_id</span></code> NetCDF global attribute. Consequently, you can use <code class="docutils literal"><span class="pre">--set-key</span> <span class="pre">institute=institute_id</span></code>.</p>
</div>
</div>
<div class="section" id="set-up-the-version-upgrade">
<h2>Set up the version upgrade<a class="headerlink" href="#set-up-the-version-upgrade" title="Permalink to this headline">¶</a></h2>
<p>The upgraded version can be set using <code class="docutils literal"><span class="pre">--version</span> <span class="pre">YYYYMMDD</span></code> instead of the current date (the default).</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs list --project PROJECT_ID /PATH/TO/SCAN/ --version YYYYMMDD
</pre></div>
</div>
</div>
<div class="section" id="visualize-the-excepted-drs-tree">
<h2>Visualize the excepted DRS tree<a class="headerlink" href="#visualize-the-excepted-drs-tree" title="Permalink to this headline">¶</a></h2>
<p>In order to save disk space, the scanned files are moved into <code class="docutils literal"><span class="pre">files/dYYYYMMDD</span></code> folders. The <code class="docutils literal"><span class="pre">vYYYYMMDD</span></code> has a
symbolic links skeleton that avoid to duplicate files between two versions.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs tree --project PROJECT_ID /PATH/TO/SCAN/
</pre></div>
</div>
</div>
<div class="section" id="set-up-a-root-directory">
<h2>Set up a root directory<a class="headerlink" href="#set-up-a-root-directory" title="Permalink to this headline">¶</a></h2>
<p>By default, the DRS tree is built from your current directory. This can be changed by submitting a root path.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs tree --project PROJECT_ID /PATH/TO/SCAN/ --root /PATH/TO/MY_ROOT
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The DRS tree is automatically rebuilt from the project level. Be careful to not submit a root path
including the project.</p>
</div>
</div>
<div class="section" id="list-unix-command-to-apply">
<h2>List Unix command to apply<a class="headerlink" href="#list-unix-command-to-apply" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal"><span class="pre">todo</span></code> action can be seen as a dry-run to check which unix commands should be apply to build the excpeted DRS
tree. At this step, no file are moved or copy to the final DRS.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs todo --project PROJECT_ID /PATH/TO/SCAN/
</pre></div>
</div>
</div>
<div class="section" id="change-the-migration-mode">
<h2>Change the migration mode<a class="headerlink" href="#change-the-migration-mode" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> allows different file migration mode.
Default is to move the files from the incomping path to the root directory. Use <code class="docutils literal"><span class="pre">--copy</span></code> to make hard copies,
<code class="docutils literal"><span class="pre">--link</span></code> to make hard links or <code class="docutils literal"><span class="pre">--symlink</span></code> to make symbolic links from the incoming path. We recommend to use
<code class="docutils literal"><span class="pre">--link</span></code> and remove the incoming directory after DRS checking. This doesn&#8217;t affect the symbolic link skeleton used
for the dataset versioning.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs todo --project PROJECT_ID /PATH/TO/SCAN/ --copy
$&gt; esgprep drs todo --project PROJECT_ID /PATH/TO/SCAN/ --link
$&gt; esgprep drs todo --project PROJECT_ID /PATH/TO/SCAN/ --symlink
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> temporarily stores the result of the <code class="docutils literal"><span class="pre">list</span></code> action to quickly generate the DRS tree
afterwards. This requires to stricly submit the same arguments from the <code class="docutils literal"><span class="pre">list</span></code> action to the following ones.
If not, the incoming files are automatically scan again.</p>
</div>
</div>
<div class="section" id="run-the-drs-upgrade">
<h2>Run the DRS upgrade<a class="headerlink" href="#run-the-drs-upgrade" title="Permalink to this headline">¶</a></h2>
<p>This will apply all the Unix command you can print with the <code class="docutils literal"><span class="pre">todo</span></code> action.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs upgrade --project PROJECT_ID /PATH/TO/SCAN/
</pre></div>
</div>
</div>
<div class="section" id="disable-checkum-comparison">
<h2>Disable checkum comparison<a class="headerlink" href="#disable-checkum-comparison" title="Permalink to this headline">¶</a></h2>
<p>To avoid mistakes in versioning, <code class="docutils literal"><span class="pre">esgprep</span> <span class="pre">drs</span></code> compares the incoming files to the files from the latest knwon version
on the filesystem using a <code class="docutils literal"><span class="pre">sha256</span></code> checksum. Because this could be time consuming <code class="docutils literal"><span class="pre">--no-checksum</span></code> allows you to only
make a comparison on filenames.</p>
<div class="highlight-bash"><div class="highlight"><pre><span></span>$&gt; esgprep drs upgrade --project PROJECT_ID /PATH/TO/SCAN/ --no-checksum
</pre></div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="check-vocab.html" class="btn btn-neutral float-right" title="Check CV against configuration INI files" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fetch-ini.html" class="btn btn-neutral" title="Fetch ESGF configuration INI files" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, Levavasseur, G..

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'./',
            VERSION:'2.7.4',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="static/jquery.js"></script>
      <script type="text/javascript" src="static/underscore.js"></script>
      <script type="text/javascript" src="static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>